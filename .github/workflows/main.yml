# 触发条件：仅当 Issue 发生了 添加标签 的动作（而不是移除标签），并且 在这次操作之后，该 Issue 的标签列表中包含了 'resolved' 标签时，这个作业才会运行。
on:
  issues:
    types: [labeled, unlabeled]

jobs:
  send_email_on_resolved:
    if: |
      github.event.action == 'labeled' &&
      contains(github.event.issue.labels.*.name, 'resolved')
    runs-on: ubuntu-latest
    
    steps:
    - name: Extract Email from Issue Body (Conditional)
      id: extract_email
      run: |
        ISSUE_BODY="${{ github.event.issue.body }}"

        LINE_FROM=$(echo "$ISSUE_BODY" | sed -n '2p')
        LINE_REPLY_TO=$(echo "$ISSUE_BODY" | sed -n '3p')

        TARGET_LINE=""

        if echo "$LINE_FROM" | grep -iq "Support"; then
          TARGET_LINE="$LINE_REPLY_TO"
          echo "Info: 'From' field contains 'Support'. Targeting 'Reply-To' line (Line 3)."
        else
          TARGET_LINE="$LINE_FROM"
          echo "Info: 'From' field does not contain 'Support'. Targeting 'From' line (Line 2)."
        fi

        EMAIL_REGEX='([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)'

        email=$(echo "$TARGET_LINE" | grep -o -E "$EMAIL_REGEX")
        
        if [ -z "$email" ]; then
          echo "::error::Could not find email address in the target line: $TARGET_LINE. Skipping email."
          echo "extracted_email=no-reply@example.com" >> "$GITHUB_OUTPUT"
        else
          echo "Extracted email: $email"
          echo "extracted_email=$email" >> "$GITHUB_OUTPUT"
        fi
      shell: bash
      
    

      # 2. 发送 Resolved 通知邮件
      - name: Send Resolved Notification Email
        uses: dawidd6/action-send-mail@v3
        # 仅在成功提取到邮箱后才运行
        if: success() && steps.extract_email.outputs.extracted_email != 'no-reply@example.com'
        with:
          # ... (SMTP 配置不变) ...
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.MAIL_FROM }}
          
          # 使用上一步骤提取的邮箱作为收件人
          to: ${{ steps.extract_email.outputs.extracted_email }}
          
          # ... (邮件内容配置不变) ...
          subject: "[Resolved] Issue # ${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
          html_body: |
            <p>Dear reporter，</p>
            <p>Your submitted GitHub Issue status has been updated:</p>
            <ul>
              <li><strong>Issue Title:</strong> <a href="${{ github.event.issue.html_url }}">${{ github.event.issue.title }}</a></li>
              <li><strong>New status:</strong> <strong> Resolved </strong></li>
            </ul>
            <p><strong><a href="${{ github.event.issue.html_url }}">Click here to view the Issue details.</a></strong></p>
            <br>
            <p>Please note: This email was sent automatically by GitHub Actions. Please do not reply directly.</p>
