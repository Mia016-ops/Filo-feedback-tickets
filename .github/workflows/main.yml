# è§¦å‘æ¡ä»¶ï¼šå½“ Issue è¢«ç¼–è¾‘ï¼ˆåŒ…æ‹¬æ ‡ç­¾æ›´æ”¹ï¼‰æ—¶
on:
  issues:
    types: [labeled, unlabeled]

jobs:
  send_email_on_resolved:
    if: |
      github.event.action == 'labeled' &&
      contains(github.event.issue.labels.*.name, 'resolved')
    runs-on: ubuntu-latest
    
    steps:
      # 1. æå–æ”¶ä»¶äººé‚®ç®±
    - name: ğŸ“© Extract Email from Issue Body (Conditional)
      id: extract_email
      run: |
        # 1. æå– Issue Body å®Œæ•´å†…å®¹
        ISSUE_BODY="${{ github.event.issue.body }}"

        # 2. æå– Issue Body ç¬¬äºŒè¡Œ
        LINE_FROM=$(echo "$ISSUE_BODY" | sed -n '2p')

        # 3. æå– Issue Body ç¬¬ä¸‰è¡Œ
        LINE_REPLY_TO=$(echo "$ISSUE_BODY" | sed -n '3p')

        # 4. åˆå§‹åŒ–ç›®æ ‡è¡Œå˜é‡
        TARGET_LINE=""

        # 5. æ£€æŸ¥ LINE_FROM æ˜¯å¦åŒ…å« "Support" (ä¸åŒºåˆ†å¤§å°å†™)
        if echo "$LINE_FROM" | grep -iq "Support"; then
          # å¦‚æœåŒ…å« "Support"ï¼Œåˆ™ä½¿ç”¨ç¬¬ 3 è¡Œ (Reply-To)
          TARGET_LINE="$LINE_REPLY_TO"
          echo "Info: 'From' field contains 'Support'. Targeting 'Reply-To' line (Line 3)."
        else
          # å¦åˆ™ï¼Œä½¿ç”¨ç¬¬ 2 è¡Œ (From)
          TARGET_LINE="$LINE_FROM"
          echo "Info: 'From' field does not contain 'Support'. Targeting 'From' line (Line 2)."
        fi

        # 6. æå–é‚®ä»¶åœ°å€çš„æ­£åˆ™è¡¨è¾¾å¼
        EMAIL_REGEX='([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)'

        # 7. ä»ç›®æ ‡è¡Œä¸­æå–é‚®ä»¶
        email=$(echo "$TARGET_LINE" | grep -o -E $EMAIL_REGEX)
        
        # 8. æ£€æŸ¥ç»“æœå¹¶è®¾ç½®è¾“å‡ºå˜é‡ ($GITHUB_OUTPUT)
        if [ -z "$email" ]; then
          echo "::error::Could not find email address in the target line: $TARGET_LINE. Skipping email."
          echo "extracted_email=no-reply@example.com" >> "$GITHUB_OUTPUT"
        else
          echo "Extracted email: $email"
          echo "extracted_email=$email" >> "$GITHUB_OUTPUT"
        fi
      shell: bash

      # 2. å‘é€ Resolved é€šçŸ¥é‚®ä»¶
      - name: âœ‰ï¸ Send Resolved Notification Email
        uses: dawidd6/action-send-mail@v3
        # ä»…åœ¨æˆåŠŸæå–åˆ°é‚®ç®±åæ‰è¿è¡Œ
        if: success() && steps.extract_email.outputs.extracted_email != 'no-reply@example.com'
        with:
          # ... (SMTP é…ç½®ä¸å˜) ...
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.MAIL_FROM }}
          
          # ä½¿ç”¨ä¸Šä¸€æ­¥éª¤æå–çš„é‚®ç®±ä½œä¸ºæ”¶ä»¶äºº
          to: ${{ steps.extract_email.outputs.extracted_email }}
          
          # ... (é‚®ä»¶å†…å®¹é…ç½®ä¸å˜) ...
          subject: "[Resolved] Issue # ${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
          html_body: |
            <p>å°Šæ•¬çš„å·¥å•æäº¤äººï¼Œ</p>
            <p>æ‚¨æäº¤çš„ GitHub Issue çŠ¶æ€å·²æ›´æ–°ï¼š</p>
            <ul>
              <li><strong>Issue æ ‡é¢˜:</strong> <a href="${{ github.event.issue.html_url }}">${{ github.event.issue.title }}</a></li>
              <li><strong>Issue ç¼–å·:</strong> #${{ github.event.issue.number }}</li>
              <li><strong>æ–°çŠ¶æ€:</strong> <strong>å·²è§£å†³ (Resolved)</strong></li>
            </ul>
            <p><strong><a href="${{ github.event.issue.html_url }}">ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹ Issue è¯¦æƒ…</a></strong></p>
            <br>
            <p>è¯·æ³¨æ„ï¼šæ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨åŒ–å‘é€ï¼Œè¯·å‹¿ç›´æ¥å›å¤ã€‚</p>
